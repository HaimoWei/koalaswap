version: "3.9"

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

networks:
  backend-net:
    driver: bridge

volumes:
  koalaswap-db-data:

services:
  db:
    image: postgres:15
    container_name: koalaswap-pg
    restart: unless-stopped
    environment:
      POSTGRES_USER: koalaswap
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: koalaswap_dev
      TZ: "UTC"
    ports:
      - "15433:5432"
    volumes:
      - koalaswap-db-data:/var/lib/postgresql/data
      - ../database/KoalaSwap_Schema_v2.0.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U koalaswap -d koalaswap_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging: *default-logging
    networks:
      - backend-net

  redis:
    image: redis:7-alpine
    container_name: koalaswap-redis
    restart: unless-stopped
    ports:
      - "16379:6379"
    command: ["redis-server", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    logging: *default-logging
    networks:
      - backend-net

  user-service:
    build:
      context: ../backend
      dockerfile: user-service/Dockerfile
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:postgresql://db:5432/koalaswap_dev}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-koalaswap}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-secret}
      SPRING_DATA_REDIS_HOST: ${SPRING_DATA_REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${SPRING_DATA_REDIS_PORT:-6379}
      SERVER_PORT: 8080

      APP_VERIFY_REDIRECT_BASE: ${APP_VERIFY_REDIRECT_BASE:-http://localhost:4200/verified}
      APP_RESET_FRONTEND_URL: ${APP_RESET_FRONTEND_URL:-http://localhost:4200}
      APP_FILE_SERVICE_BASE_URL: http://file-service:8080
      APP_TOKEN_FRESHNESS_USE_REDIS: "true"
      APP_TOKEN_FRESHNESS_TTL_SEC: 8
      APP_TOKEN_FRESHNESS_CHANNEL: ${APP_TOKEN_FRESHNESS_CHANNEL:-auth:pv:changed}
      APP_USER_SERVICE_INTERNAL_BASE_URL: http://user-service:8080
    ports:
      - "12649:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/actuator/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
    logging: *default-logging
    networks:
      - backend-net

  product-service:
    build:
      context: ../backend
      dockerfile: product-service/Dockerfile
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:postgresql://db:5432/koalaswap_dev}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-koalaswap}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-secret}
      SPRING_DATA_REDIS_HOST: ${SPRING_DATA_REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${SPRING_DATA_REDIS_PORT:-6379}
      SERVER_PORT: 8080

      APP_USER_SERVICE_INTERNAL_BASE_URL: http://user-service:8080
      APP_FILE_SERVICE_BASE_URL: http://file-service:8080
      APP_TOKEN_FRESHNESS_USE_REDIS: "true"
      APP_TOKEN_FRESHNESS_TTL_SEC: 8
      APP_TOKEN_FRESHNESS_CHANNEL: ${APP_TOKEN_FRESHNESS_CHANNEL:-auth:pv:changed}
    ports:
      - "12648:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/actuator/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
    logging: *default-logging
    networks:
      - backend-net

  order-service:
    build:
      context: ../backend
      dockerfile: order-service/Dockerfile
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:postgresql://db:5432/koalaswap_dev}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-koalaswap}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-secret}
      SPRING_DATA_REDIS_HOST: ${SPRING_DATA_REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${SPRING_DATA_REDIS_PORT:-6379}
      SERVER_PORT: 8080

      APP_PRODUCT_SERVICE_INTERNAL_BASE_URL: http://product-service:8080
      APP_USER_SERVICE_INTERNAL_BASE_URL: http://user-service:8080
      APP_ORDER_PENDING_EXPIRE_MINUTES: 30
      APP_TOKEN_FRESHNESS_USE_REDIS: "true"
      APP_TOKEN_FRESHNESS_TTL_SEC: 8
      APP_TOKEN_FRESHNESS_CHANNEL: ${APP_TOKEN_FRESHNESS_CHANNEL:-auth:pv:changed}
      APP_ORDER_EVENTS_CHANNEL: ${APP_ORDER_EVENTS_CHANNEL:-orders:completed}
    ports:
      - "12650:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/actuator/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
    logging: *default-logging
    networks:
      - backend-net

  review-service:
    build:
      context: ../backend
      dockerfile: review-service/Dockerfile
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
      order-service:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:postgresql://db:5432/koalaswap_dev}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-koalaswap}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-secret}
      SPRING_DATA_REDIS_HOST: ${SPRING_DATA_REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${SPRING_DATA_REDIS_PORT:-6379}
      SERVER_PORT: 8080

      APP_USER_SERVICE_EXTERNAL_BASE_URL: http://user-service:8080
      APP_PRODUCT_SERVICE_EXTERNAL_BASE_URL: http://product-service:8080
      APP_USER_SERVICE_INTERNAL_BASE_URL: http://user-service:8080
      APP_PRODUCT_SERVICE_INTERNAL_BASE_URL: http://product-service:8080
      APP_TOKEN_FRESHNESS_USE_REDIS: "true"
      APP_TOKEN_FRESHNESS_TTL_SEC: 8
      APP_TOKEN_FRESHNESS_CHANNEL: ${APP_TOKEN_FRESHNESS_CHANNEL:-auth:pv:changed}
      APP_ORDER_EVENTS_ENABLED: "true"
      APP_ORDER_EVENTS_CHANNEL: ${APP_ORDER_EVENTS_CHANNEL:-orders:completed}
    ports:
      - "12651:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/actuator/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
    logging: *default-logging
    networks:
      - backend-net

  chat-service:
    build:
      context: ../backend
      dockerfile: chat-service/Dockerfile
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
      order-service:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:postgresql://db:5432/koalaswap_dev}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-koalaswap}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-secret}
      SPRING_DATA_REDIS_HOST: ${SPRING_DATA_REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${SPRING_DATA_REDIS_PORT:-6379}
      SERVER_PORT: 8080

      KOALASWAP_SERVICES_USER_BASE_URL: http://user-service:8080
      KOALASWAP_SERVICES_PRODUCT_BASE_URL: http://product-service:8080
      KOALASWAP_SERVICES_ORDER_BASE_URL: http://order-service:8080
      APP_USER_SERVICE_INTERNAL_BASE_URL: http://user-service:8080
      APP_PRODUCT_SERVICE_INTERNAL_BASE_URL: http://product-service:8080
      APP_ORDER_SERVICE_INTERNAL_BASE_URL: http://order-service:8080
      APP_TOKEN_FRESHNESS_USE_REDIS: "true"
      APP_TOKEN_FRESHNESS_TTL_SEC: 8
      APP_TOKEN_FRESHNESS_CHANNEL: ${APP_TOKEN_FRESHNESS_CHANNEL:-auth:pv:changed}
      CHAT_WS_ALLOW_ORIGINS: ${CHAT_WS_ALLOW_ORIGINS:-*}
      CHAT_ORDER_REDIS_CHANNEL: ${CHAT_ORDER_REDIS_CHANNEL:-orders:status-changed}
    ports:
      - "12652:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/actuator/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
    logging: *default-logging
    networks:
      - backend-net

  file-service:
    build:
      context: ../backend
      dockerfile: file-service/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      SPRING_DATA_REDIS_HOST: ${SPRING_DATA_REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${SPRING_DATA_REDIS_PORT:-6379}
      SERVER_PORT: 8080

      APP_USER_SERVICE_INTERNAL_BASE_URL: http://user-service:8080
      APP_TOKEN_FRESHNESS_USE_REDIS: "true"
      APP_TOKEN_FRESHNESS_TTL_SEC: 8
      APP_TOKEN_FRESHNESS_CHANNEL: ${APP_TOKEN_FRESHNESS_CHANNEL:-auth:pv:changed}
      AWS_REGION: ${AWS_REGION:-ap-southeast-2}
      S3_BUCKET: ${S3_BUCKET:-koalaswap}
      CDN_BASE: ${CDN_BASE:-https://d3367sa0s3hyt3.cloudfront.net}
      AWS_PRESIGNED_MINUTES: ${AWS_PRESIGNED_MINUTES:-15}
    ports:
      - "12647:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/actuator/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
    logging: *default-logging
    networks:
      - backend-net

  gateway-service:
    build:
      context: ../backend
      dockerfile: gateway-service/Dockerfile
    depends_on:
      user-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
      order-service:
        condition: service_healthy
      review-service:
        condition: service_healthy
      chat-service:
        condition: service_healthy
      file-service:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      SERVER_PORT: 8080
      APP_CORS_ALLOWED_ORIGINS: ${APP_CORS_ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173,http://localhost:4200}
      USER_SERVICE_URL: http://user-service:8080
      PRODUCT_SERVICE_URL: http://product-service:8080
      ORDER_SERVICE_URL: http://order-service:8080
      REVIEW_SERVICE_URL: http://review-service:8080
      CHAT_SERVICE_URL: http://chat-service:8080
      CHAT_WS_URL: http://chat-service:8080
      FILE_SERVICE_URL: http://file-service:8080
    ports:
      - "18080:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/actuator/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
    logging: *default-logging
    networks:
      - backend-net
