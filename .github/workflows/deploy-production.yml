name: Deploy to Production

on:
  push:
    branches:
      - main  # 当推送到main分支时触发
  workflow_dispatch:  # 允许手动触发

env:
  AWS_REGION: ap-southeast-2
  ECR_REGISTRY: 143223323809.dkr.ecr.ap-southeast-2.amazonaws.com
  ECR_REPOSITORY: koalaswap

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build all services with Maven
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw clean package -DskipTests
        shell: bash

      - name: Build and push Docker images
        run: |
          cd backend

          # Build and push each service
          services=("user-service" "product-service" "order-service" "review-service" "chat-service" "file-service" "gateway-service")

          for service in "${services[@]}"; do
            echo "Building $service..."
            docker build -f $service/Dockerfile -t $ECR_REGISTRY/$ECR_REPOSITORY:$service-prod .
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$service-prod
            echo "✅ $service pushed successfully"
          done
        shell: bash

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-web/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend-web
          npm ci

      - name: Build frontend
        run: |
          cd frontend-web
          npm run build
        env:
          NODE_ENV: production

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend-web/dist
          retention-days: 1

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [build-and-push, build-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-web/dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2-key.pem
          chmod 600 ~/.ssh/ec2-key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Upload frontend to EC2
        run: |
          cd frontend-web
          tar czf frontend-dist.tar.gz dist/
          scp -i ~/.ssh/ec2-key.pem frontend-dist.tar.gz ubuntu@${{ secrets.EC2_HOST }}:/tmp/
          ssh -i ~/.ssh/ec2-key.pem ubuntu@${{ secrets.EC2_HOST }} "
            sudo rm -rf /opt/koalaswap/frontend-dist/*
            sudo tar xzf /tmp/frontend-dist.tar.gz -C /opt/koalaswap/frontend-dist --strip-components=1
            rm /tmp/frontend-dist.tar.gz
          "

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/ec2-key.pem ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e

            cd /opt/koalaswap

            # Get ECR login password
            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_REGION=${{ env.AWS_REGION }}

            aws ecr get-login-password --region $AWS_REGION | \
              docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

            # Pull latest images
            docker compose -f docker-compose.prod.yml pull

            # Restart services with new images
            docker compose -f docker-compose.prod.yml up -d

            # Wait for services to be healthy
            sleep 30

            # Check health
            docker compose -f docker-compose.prod.yml ps

            echo "✅ Deployment completed successfully!"
          ENDSSH

      - name: Verify deployment
        run: |
          # Wait a bit for services to stabilize
          sleep 10

          # Check API health
          curl -f https://api.koalaswap.lightspot.uk/actuator/health || exit 1

          # Check frontend
          curl -f https://koalaswap.lightspot.uk/health || exit 1

          echo "✅ Health checks passed!"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/ec2-key.pem
